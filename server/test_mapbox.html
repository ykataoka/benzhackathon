<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
  
<style>
.marker {
    display: block;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
}
</style>

<div id='map'></div>

<!-- Web Socket Receiving -->
<!--     <script src="/socket.io/socket.io.js"></script> -->
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
var socket = io('http://localhost:8880');

// Ws : session initiation
socket.on('news', function (data){
  socket.emit('my other event', {hoge : 'hogehoge'});
});

socket.on('geo_data_d', function (data){
//    console.log("recieved geo_data by WS.");
  current_geojson_d = JSON.stringify(data);
  current_geojson_d = JSON.parse(current_geojson_d);
});

socket.on('geo_data_a', function (data){
//    console.log("recieved geo_data by WS.");
  current_geojson_a = JSON.stringify(data);
  current_geojson_a = JSON.parse(current_geojson_a);
});

socket.on('geo_data_e', function (data){
//    console.log("recieved geo_data by WS.");
  current_geojson_e = JSON.stringify(data);
  current_geojson_e = JSON.parse(current_geojson_e);
});

socket.on('geo_data_k', function (data){
//    console.log("recieved geo_data by WS.");
  current_geojson_k = JSON.stringify(data);
  current_geojson_k = JSON.parse(current_geojson_k);
});


mapboxgl.accessToken = 'pk.eyJ1IjoieWthdGFva2EiLCJhIjoiY2lyNzJqdGVwMDB2Y2c3bTNudzh6eW8xNiJ9.uApWXlksYc3pMyjMW46jkg';
var geojson = {
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "properties": {
                "message": "Foo",
                "iconSize": [60, 60]
            },
            "geometry": {
                "type": "Point",
                "coordinates":  [-122.486695, 37.774346]
            }
        }
      ,
        {
            "type": "Feature",
            "properties": {
                "message": "Bar",
                "iconSize": [50, 50]
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-122.486695, 37.774346]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "message": "Baz",
                "iconSize": [40, 40]
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-122.486695, 37.774346]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "message": "Baz",
                "iconSize": [40, 40]
            },
            "geometry": {
                "type": "Point",
                "coordinates": [-122.486695, 37.774346]
            }
        }
    ]
};


var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v9',
  center: [-122.486695, 37.774346],
  zoom: 9
});

// original example of mapbox
// add markers to map

// org
// geojson.features.forEach(function(marker) {
//     // create a DOM element for the marker
//     var el = document.createElement('div');
//     el.className = 'marker';
//     el.style.backgroundImage = 'url(https://placekitten.com/g/' + marker.properties.iconSize.join('/') + '/)';
//     el.style.width = marker.properties.iconSize[0] + 'px';
//     el.style.height = marker.properties.iconSize[1] + 'px';
// 
//     el.addEventListener('click', function() {
//         window.alert(marker.properties.message);
//     });
// 
//     // add marker to map
//     new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
//         .setLngLat(marker.geometry.coordinates)
//         .addTo(map);
// });

// every one second, update the gps data
setInterval(function(){
  var elem = document.getElementById("d");
  if(elem!==null){
    elem.parentNode.removeChild(elem);
  }
  var elem = document.getElementById("a");
  if(elem!==null){
    elem.parentNode.removeChild(elem);
  }
  var elem = document.getElementById("e");
  if(elem!==null){
    elem.parentNode.removeChild(elem);
  }
  var elem = document.getElementById("k");
  if(elem!==null){
    elem.parentNode.removeChild(elem);
  }
  
  var i = 0
  geojson.features.forEach(function(marker) {
    // create a DOM element for the marker
//    var el = document.createElement('div');
    var el = document.createElement('button');
    if(i==0){
      el.id = 'd';
      $(function() {
	$('#d').attr('data-toggle', 'modal_a');
	$('#d').attr('data-target', '#myModal_d');
      });
    }else if(i==1){
      el.id = 'a';
      $(function() {
	$('#a').attr('data-toggle', 'modal_a');
	$('#a').attr('data-target', '#myModal_a');
      });
    }else if(i==2){
      el.id = 'e';
      $(function() {
	$('#e').attr('data-toggle', 'modal_e');
	$('#e').attr('data-target', '#myModal_e');
      });
    }else if(i==3){
      el.id = 'k';
      $(function() {
	$('#k').attr('data-toggle', 'modal_k');
	$('#k').attr('data-target', '#myModal_k');
      });
    }
    
//    el.className = 'marker btn btn-info btn-lg';
    el.className = 'marker btn btn-info btn-lg';
//    el.data-toggle = 'modal';
//    el.data-target = 'myModal';
    el.style.backgroundImage = 'url(https://placekitten.com/g/' + marker.properties.iconSize.join('/') + '/)';
    el.style.width = marker.properties.iconSize[0] + 'px';
    el.style.height = marker.properties.iconSize[1] + 'px';
    
//    el.addEventListener('click', function() {
//      window.alert(marker.properties.message);
//    });
    console.log(i);
    i++;
    
    // add marker to map
    new mapboxgl.Marker(el, {offset: [-marker.properties.iconSize[0] / 2, -marker.properties.iconSize[1] / 2]})
      .setLngLat(marker.geometry.coordinates)
      .addTo(map);
  });
  
  // update the geo location
  console.log(geojson['features'][0]['geometry']['coordinates']);
  console.log(geojson['features'][1]['geometry']['coordinates']);
  console.log(geojson['features'][2]['geometry']['coordinates']);
  console.log(geojson['features'][3]['geometry']['coordinates']);
  geojson['features'][0]['geometry']['coordinates'] = current_geojson_d['geometry']['coordinates']
  geojson['features'][1]['geometry']['coordinates'] = current_geojson_a['geometry']['coordinates']
  geojson['features'][2]['geometry']['coordinates'] = current_geojson_e['geometry']['coordinates']
  geojson['features'][3]['geometry']['coordinates'] = current_geojson_k['geometry']['coordinates']

  // update button d
  $( "#d" ).click(function() {
    $('#myModal_d').modal({
        show: true
    });
  });
  $('#myModal_d').on('shown.bs.modal', function () {
    $("#txtname").focus();
  });
  // show the modal onload
  $('#myModal_d').modal({
    show: false
  });

  // update button a
  $( "#a" ).click(function() {
    $('#myModal_a').modal({
        show: true
    });
  });
  $('#myModal_a').on('shown.bs.modal', function () {
    $("#txtname").focus();
  });
  // show the modal onload
  $('#myModal_a').modal({
    show: false
  });
  
  // update button e
  $( "#e" ).click(function() {
    $('#myModal_e').modal({
        show: true
    });
  });
  $('#myModal_e').on('shown.bs.modal', function () {
    $("#txtname").focus();
  });
  // show the modal onload
  $('#myModal_e').modal({
    show: false
  });

  // update button k
  $( "#k" ).click(function() {
    $('#myModal_k').modal({
        show: true
    });
  });
  $('#myModal_k').on('shown.bs.modal', function () {
    $("#txtname").focus();
  });
  // show the modal onload
  $('#myModal_k').modal({
    show: false
  });

  
  
  //    console.log("hogehoge");
  //    console.log(current_geojson);
  //    featureLayer.eachLayer(function(l) {
  //      map.panTo(l.getLatLng());
  //    });
  //    featureLayer.setGeoJSON(current_geojson).addTo(map);
}, 1000);

  

// someone's site example
//map.featureLayer.on('layeradd', function(e) {
//    var marker = e.layer;
//    // custom popup content
//    var popupContent =  getTitle(marker);
//    marker.bindPopup(popupContent,{
//        closeButton: false
//    });
//    // customize click event
//    marker.on('click', function(e) {
//        // zoom on the marker
//        if(map.getZoom() > marker.feature.properties.zoom) {
//            map.setView(e.latlng, map.getZoom());   
//        } else {
//            map.setView(e.latlng, marker.feature.properties.zoom);
//        }
//        // jQuery to update the content of a particular div with some other content
//        $(function () {
//            $("#travel-div").load(getPage(marker)).hide().fadeIn('slow');
//        });
//    });
//});

</script>

<!-- 
<button type="button"
	class="btn btn-info btn-lg"
	data-toggle="modal"
	data-target="#myModal">Open Modal</button>
-->

<!-- Modal_d -->
<div id="myModal_d" class="modal fade" role="dialog">
  <div class="modal-dialog">    
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
        <p>Some text in the modal.</p>

	<iframe src="http://localhost:3000/dashboard-solo/db/remaining-battery?editorTab=Axes&panelId=1&from=now-5m&to=now&theme=light"
		style="width:100%;"
		height="300"
		frameborder="0">
	</iframe>
      </div>

      
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal_a -->
<div id="myModal_a" class="modal fade" role="dialog">
  <div class="modal-dialog">    
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
        <p>Some text in the modal.</p>
	<iframe src="http://localhost:3000/dashboard-solo/db/remaining-battery?editorTab=Axes&panelId=2&from=now-5m&to=now&theme=light"
		style="width:100%;"
		height="300"
		frameborder="0">
	</iframe>
	
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal_e -->
<div id="myModal_e" class="modal fade" role="dialog">
  <div class="modal-dialog">    
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
        <p>Some text in the modal.</p>
	<iframe src="http://localhost:3000/dashboard-solo/db/remaining-battery?editorTab=Axes&panelId=3&from=now-5m&to=now&theme=light"
		style="width:100%;"
		height="300"
		frameborder="0">
	</iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal_k -->
<div id="myModal_k" class="modal fade" role="dialog">
  <div class="modal-dialog">    
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Modal Header</h4>
      </div>
      <div class="modal-body">
        <p>Some text in the modal.</p>
	<iframe src="http://localhost:3000/dashboard-solo/db/remaining-battery?editorTab=Axes&panelId=4&from=now-5m&to=now&theme=light"
		style="width:100%;"
		height="300"
		frameborder="0">
	</iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


</body>

</html>
